

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>ChildProject.pipelines.zooniverse &mdash; ChildProject 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ChildProject
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting-started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-data.html">Getting some data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../format.html">Datasets structure</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reuse.html">How to reuse GIN datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../vandam.html">Converting a dataset</a></li>
</ul>
<p class="caption"><span class="caption-text">Command-line tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">Basic tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../samplers.html">Samplers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../elan.html">ELAN builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zooniverse.html">Zooniverse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cheatsheet.html">Cheatsheet</a></li>
</ul>
<p class="caption"><span class="caption-text">Package reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">ChildProject</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples of python scripts</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ChildProject</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ChildProject.pipelines.zooniverse</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ChildProject.pipelines.zooniverse</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">panoptes_client</span> <span class="kn">import</span> <span class="n">Panoptes</span><span class="p">,</span> <span class="n">Project</span><span class="p">,</span> <span class="n">Subject</span><span class="p">,</span> <span class="n">SubjectSet</span><span class="p">,</span> <span class="n">Classification</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">yaml</span> <span class="kn">import</span> <span class="n">dump</span>

<span class="kn">from</span> <span class="nn">pydub</span> <span class="kn">import</span> <span class="n">AudioSegment</span>

<span class="kn">import</span> <span class="nn">ChildProject</span>
<span class="kn">from</span> <span class="nn">ChildProject.pipelines.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>

<div class="viewcode-block" id="pad_interval"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.pad_interval">[docs]</a><span class="k">def</span> <span class="nf">pad_interval</span><span class="p">(</span><span class="n">onset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">chunks_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">chunks_min_amount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">offset</span><span class="o">-</span><span class="n">onset</span>

    <span class="n">target_length</span> <span class="o">=</span> <span class="n">chunks_length</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">chunks_min_amount</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="n">chunks_length</span><span class="p">))</span>
    <span class="n">onset</span> <span class="o">-=</span> <span class="p">(</span><span class="n">target_length</span> <span class="o">-</span> <span class="n">length</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">target_length</span> <span class="o">-</span> <span class="n">length</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">onset</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chunk"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.Chunk">[docs]</a><span class="k">class</span> <span class="nc">Chunk</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording_filename</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">segment_onset</span><span class="p">,</span> <span class="n">segment_offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording_filename</span> <span class="o">=</span> <span class="n">recording_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onset</span> <span class="o">=</span> <span class="n">onset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">segment_onset</span> <span class="o">=</span> <span class="n">segment_onset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment_offset</span> <span class="o">=</span> <span class="n">segment_offset</span>


<div class="viewcode-block" id="Chunk.getbasename"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.Chunk.getbasename">[docs]</a>    <span class="k">def</span> <span class="nf">getbasename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onset</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">extension</span>
        <span class="p">)</span></div></div>

<div class="viewcode-block" id="ZooniversePipeline"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.ZooniversePipeline">[docs]</a><span class="k">class</span> <span class="nc">ZooniversePipeline</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ZooniversePipeline.get_credentials"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.ZooniversePipeline.get_credentials">[docs]</a>    <span class="k">def</span> <span class="nf">get_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns input credentials if provided or attempts to read them</span>
<span class="sd">        from the environment variables.</span>

<span class="sd">        :param login: input login, defaults to &#39;&#39;</span>
<span class="sd">        :type login: str, optional</span>
<span class="sd">        :param pwd: input password, defaults to &#39;&#39;</span>
<span class="sd">        :type pwd: str, optional</span>
<span class="sd">        :return: (login, pwd)</span>
<span class="sd">        :rtype: (str, str)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">login</span> <span class="ow">and</span> <span class="n">pwd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_login</span> <span class="o">=</span> <span class="n">login</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_pwd</span> <span class="o">=</span> <span class="n">pwd</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_login</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_pwd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ZOONIVERSE_LOGIN&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_login</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ZOONIVERSE_LOGIN&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no login specified, and no &#39;ZOONIVERSE_LOGIN&#39; environment variable found&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ZOONIVERSE_PWD&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ZOONIVERSE_PWD&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no password specified, and no &#39;ZOONIVERSE_PWD&#39; environment variable found&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_login</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_pwd</span><span class="p">)</span></div>

                
    <span class="k">def</span> <span class="nf">_split_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segments</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;records&#39;</span><span class="p">)</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">recording</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;recording_filename&#39;</span><span class="p">]</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">get_recording_path</span><span class="p">(</span><span class="n">recording</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>

        <span class="n">audio</span> <span class="o">=</span> <span class="n">AudioSegment</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extracting chunks from </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
            <span class="n">original_onset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s1">&#39;segment_onset&#39;</span><span class="p">])</span>
            <span class="n">original_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s1">&#39;segment_offset&#39;</span><span class="p">])</span>
            <span class="n">onset</span> <span class="o">=</span> <span class="n">original_onset</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">original_offset</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">onset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pad_interval</span><span class="p">(</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks_min_amount</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">onset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skipping chunk with negative onset (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">onset</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">intervals</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks_length</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks_length</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="p">[(</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">)]</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">Chunk</span><span class="p">(</span>
                    <span class="n">segment</span><span class="p">[</span><span class="s1">&#39;recording_filename&#39;</span><span class="p">],</span>
                    <span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                    <span class="n">original_onset</span><span class="p">,</span> <span class="n">original_offset</span>
                <span class="p">)</span>
                <span class="n">chunk_audio</span> <span class="o">=</span> <span class="n">audio</span><span class="p">[</span><span class="n">chunk</span><span class="o">.</span><span class="n">onset</span><span class="p">:</span><span class="n">chunk</span><span class="o">.</span><span class="n">offset</span><span class="p">]</span><span class="o">.</span><span class="n">fade_in</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">fade_out</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

                <span class="n">wav</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;chunks&#39;</span><span class="p">,</span> <span class="n">chunk</span><span class="o">.</span><span class="n">getbasename</span><span class="p">(</span><span class="s1">&#39;wav&#39;</span><span class="p">))</span>
                <span class="n">mp3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;chunks&#39;</span><span class="p">,</span> <span class="n">chunk</span><span class="o">.</span><span class="n">getbasename</span><span class="p">(</span><span class="s1">&#39;mp3&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wav</span><span class="p">):</span>
                    <span class="n">chunk_audio</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">wav</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;wav&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> already exists, exportation skipped.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wav</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mp3</span><span class="p">):</span>
                    <span class="n">chunk_audio</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">mp3</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;mp3&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> already exists, exportation skipped.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mp3</span><span class="p">))</span>


                <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chunks</span>

<div class="viewcode-block" id="ZooniversePipeline.extract_chunks"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.ZooniversePipeline.extract_chunks">[docs]</a>    <span class="k">def</span> <span class="nf">extract_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">segments</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">chunks_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">chunks_min_amount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">profile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;extract-audio chunks based on a list of segments and prepare them for upload</span>
<span class="sd">        to zooniverse.</span>

<span class="sd">        :param path: dataset path</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :param destination: path to the folder where to store the metadata and audio chunks</span>
<span class="sd">        :type destination: str</span>
<span class="sd">        :param segments: path to the input segments csv dataframe, defaults to None</span>
<span class="sd">        :type segments: str</span>
<span class="sd">        :param keyword: keyword to insert in the output metadata</span>
<span class="sd">        :type keyword: str</span>
<span class="sd">        :param chunks_length: length of the chunks, in milliseconds, defaults to -1</span>
<span class="sd">        :type chunks_length: int, optional</span>
<span class="sd">        :param chunks_min_amount: minimum amount of chunk per segment, defaults to 1</span>
<span class="sd">        :type chunks_min_amount: int, optional</span>
<span class="sd">        :param profile: recording profile to extract from. If undefined, raw recordings will be used.</span>
<span class="sd">        :type profile: str</span>
<span class="sd">        :param threads: amount of threads to run-on, defaults to 0</span>
<span class="sd">        :type threads: int, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="s1">&#39;kwargs&#39;</span><span class="p">]]</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">extend</span><span class="p">([{</span><span class="n">key</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">destination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">ChildProject</span><span class="o">.</span><span class="n">projects</span><span class="o">.</span><span class="n">ChildProject</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunks_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_min_amount</span> <span class="o">=</span> <span class="n">chunks_min_amount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span>

        <span class="n">threads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>

        <span class="n">destination_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;chunks&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_path</span><span class="p">,</span> <span class="n">exist_ok</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;segments.csv&#39;</span><span class="p">))</span>

        <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_recording</span><span class="p">,</span> <span class="n">_segments</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;recording_filename&#39;</span><span class="p">):</span>
            <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_segments</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">recording_filename</span> <span class="o">=</span> <span class="n">_recording</span><span class="p">))</span>
        
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">threads</span> <span class="k">if</span> <span class="n">threads</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_split_recording</span><span class="p">,</span> <span class="n">segments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
            <span class="s1">&#39;recording_filename&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">recording_filename</span><span class="p">,</span>
            <span class="s1">&#39;onset&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">onset</span><span class="p">,</span>
            <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
            <span class="s1">&#39;segment_onset&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">segment_onset</span><span class="p">,</span>
            <span class="s1">&#39;segment_offset&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">segment_offset</span><span class="p">,</span>
            <span class="s1">&#39;wav&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">getbasename</span><span class="p">(</span><span class="s1">&#39;wav&#39;</span><span class="p">),</span>
            <span class="s1">&#39;mp3&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">getbasename</span><span class="p">(</span><span class="s1">&#39;mp3&#39;</span><span class="p">),</span>
            <span class="s1">&#39;date_extracted&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
            <span class="s1">&#39;uploaded&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;project_id&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;subject_set&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;zooniverse_id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="n">keyword</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">])</span>

        <span class="c1"># shuffle chunks so that they can&#39;t be joined back together</span>
        <span class="c1"># based on Zooniverse subject IDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span>

        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">chunks_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;chunks_</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">))</span>
        <span class="n">parameters_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;parameters_</span><span class="si">{}</span><span class="s1">.yml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">chunks_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;exported chunks metadata to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chunks_path</span><span class="p">))</span>
        <span class="n">dump</span><span class="p">({</span>
            <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
            <span class="s1">&#39;package_version&#39;</span><span class="p">:</span> <span class="n">ChildProject</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span>
        <span class="p">},</span> <span class="nb">open</span><span class="p">(</span><span class="n">parameters_path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;exported extract-chunks parameters to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameters_path</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">chunks_path</span><span class="p">,</span> <span class="n">parameters_path</span></div>

<div class="viewcode-block" id="ZooniversePipeline.upload_chunks"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.ZooniversePipeline.upload_chunks">[docs]</a>    <span class="k">def</span> <span class="nf">upload_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunks</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">set_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">zooniverse_login</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">zooniverse_pwd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uploads ``amount`` audio chunks from the CSV dataframe `chunks` to a zooniverse project.</span>

<span class="sd">        :param chunks: path to the chunk CSV dataframe</span>
<span class="sd">        :type chunks: [type]</span>
<span class="sd">        :param project_id: zooniverse project id</span>
<span class="sd">        :type project_id: int</span>
<span class="sd">        :param set_name: name of the subject set</span>
<span class="sd">        :type set_name: str</span>
<span class="sd">        :param zooniverse_login: zooniverse login. If not specified, the program attempts to get it from the environment variable ``ZOONIVERSE_LOGIN`` instead, defaults to &#39;&#39;</span>
<span class="sd">        :type zooniverse_login: str, optional</span>
<span class="sd">        :param zooniverse_pwd: zooniverse password. If not specified, the program attempts to get it from the environment variable ``ZOONIVERSE_PWD`` instead, defaults to &#39;&#39;</span>
<span class="sd">        :type zooniverse_pwd: str, optional</span>
<span class="sd">        :param amount: amount of chunks to upload, defaults to 0</span>
<span class="sd">        :type amount: int, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_file</span> <span class="o">=</span> <span class="n">chunks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_credentials</span><span class="p">(</span><span class="n">zooniverse_login</span><span class="p">,</span> <span class="n">zooniverse_pwd</span><span class="p">)</span>

        <span class="n">metadata_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">metadata_location</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;cannot read chunk metadata from </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metadata_location</span><span class="p">))</span>

        <span class="n">Panoptes</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_login</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_pwd</span><span class="p">)</span>
        <span class="n">zooniverse_project</span> <span class="o">=</span> <span class="n">Project</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>

        <span class="n">subjects_metadata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">uploaded</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">subject_set</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">zooniverse_project</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">subject_sets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">display_name</span> <span class="o">==</span> <span class="n">set_name</span><span class="p">:</span>
                <span class="n">subject_set</span> <span class="o">=</span> <span class="n">ss</span>

        <span class="k">if</span> <span class="n">subject_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subject_set</span> <span class="o">=</span> <span class="n">SubjectSet</span><span class="p">()</span>
            <span class="n">subject_set</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">zooniverse_project</span>
            <span class="n">subject_set</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">set_name</span>
            <span class="n">subject_set</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="n">subjects</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">chunks_to_upload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">[</span><span class="s1">&#39;uploaded&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
        <span class="n">chunks_to_upload</span> <span class="o">=</span> <span class="n">chunks_to_upload</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks_to_upload</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nothing left to upload.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">chunk_index</span> <span class="ow">in</span> <span class="n">chunks_to_upload</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunks_to_upload</span><span class="p">[</span><span class="n">chunk_index</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;uploading chunk </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;recording_filename&#39;</span><span class="p">],</span> <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;onset&#39;</span><span class="p">],</span> <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]))</span>

            <span class="n">subject</span> <span class="o">=</span> <span class="n">Subject</span><span class="p">()</span>
            <span class="n">subject</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">zooniverse_project</span>
            <span class="n">subject</span><span class="o">.</span><span class="n">add_location</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks_file</span><span class="p">),</span> <span class="s1">&#39;chunks&#39;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;mp3&#39;</span><span class="p">]))</span>
            <span class="n">subject</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;date_extracted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;date_extracted&#39;</span><span class="p">]</span>
            <span class="n">subject</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

            <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk_index</span>
            <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;zooniverse_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">subject</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;project_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
            <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;subject_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">subject_set</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>
            <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;uploaded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">subjects_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            
        <span class="n">subject_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">subjects_metadata</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="ZooniversePipeline.retrieve_classifications"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.ZooniversePipeline.retrieve_classifications">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_classifications</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">zooniverse_login</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">zooniverse_pwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">        :param destination: output CSV dataframe destination</span>
<span class="sd">        :type destination: str</span>
<span class="sd">        :param project_id: zooniverse project id</span>
<span class="sd">        :type project_id: int</span>
<span class="sd">        :param zooniverse_login: zooniverse login. If not specified, the program attempts to get it from the environment variable ``ZOONIVERSE_LOGIN`` instead, defaults to &#39;&#39;</span>
<span class="sd">        :type zooniverse_login: str, optional</span>
<span class="sd">        :param zooniverse_pwd: zooniverse password. If not specified, the program attempts to get it from the environment variable ``ZOONIVERSE_PWD`` instead, defaults to &#39;&#39;</span>
<span class="sd">        :type zooniverse_pwd: str, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_credentials</span><span class="p">(</span><span class="n">zooniverse_login</span><span class="p">,</span> <span class="n">zooniverse_pwd</span><span class="p">)</span>

        <span class="n">Panoptes</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_login</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zooniverse_pwd</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>

        <span class="n">answers_translation_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">workflow</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">workflows</span><span class="p">:</span>
            <span class="n">workflow_id</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">id</span>
            <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">][</span><span class="s1">&#39;answers&#39;</span><span class="p">]:</span>
                    <span class="n">answers_translation_table</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;workflow_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">),</span>
                        <span class="s1">&#39;task_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">task_id</span><span class="p">),</span>
                        <span class="s1">&#39;answer_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>
                        <span class="s1">&#39;answer&#39;</span><span class="p">:</span> <span class="n">answer</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                    <span class="p">})</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">answers_translation_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">answers_translation_table</span><span class="p">)</span>

        <span class="n">classifications</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">Classification</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span>
            <span class="n">page_size</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="n">project_id</span>
        <span class="p">):</span>
            <span class="n">classifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>

        <span class="n">classifications</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">classifications</span><span class="p">)</span>
        <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span>
        <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;workflow_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">])</span>
        <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;task&#39;</span><span class="p">]))</span>
        <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classifications</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>

        <span class="n">classifications</span> <span class="o">=</span> <span class="n">classifications</span><span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;task_id&#39;</span><span class="p">,</span> <span class="s1">&#39;answer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;workflow_id&#39;</span><span class="p">]]</span>
        <span class="n">classifications</span> <span class="o">=</span> <span class="n">classifications</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">answers_translation_table</span><span class="p">,</span>
            <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;workflow_id&#39;</span><span class="p">,</span> <span class="s1">&#39;task_id&#39;</span><span class="p">,</span> <span class="s1">&#39;answer_id&#39;</span><span class="p">],</span>
            <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;workflow_id&#39;</span><span class="p">,</span> <span class="s1">&#39;task_id&#39;</span><span class="p">,</span> <span class="s1">&#39;answer_id&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">classifications</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span></div>

<div class="viewcode-block" id="ZooniversePipeline.run"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.ZooniversePipeline.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;extract-chunks&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_chunks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;upload-chunks&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_chunks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;retrieve-classifications&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve_classifications</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ZooniversePipeline.setup_parser"><a class="viewcode-back" href="../../../ChildProject.pipelines.html#ChildProject.pipelines.zooniverse.ZooniversePipeline.setup_parser">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">setup_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
        <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="n">dest</span> <span class="o">=</span> <span class="s1">&#39;action&#39;</span><span class="p">)</span>

        <span class="n">parser_extraction</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;extract-chunks&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;extract chunks to &lt;destination&gt;, and exports the metadata inside of this directory&#39;</span><span class="p">)</span>
        <span class="n">parser_extraction</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;path to the dataset&#39;</span><span class="p">)</span>
        <span class="n">parser_extraction</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--keyword&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;export keyword&#39;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">parser_extraction</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--chunks-length&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;chunk length (in milliseconds). if &lt;= 0, the segments will not be split into chunks (default value: 0)&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">parser_extraction</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--chunks-min-amount&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;minimum amount of chunks to extract from a segment (default value: 1)&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">parser_extraction</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--segments&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;path to the input segments dataframe&#39;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">parser_extraction</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--destination&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;destination&#39;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">parser_extraction</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--profile&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Recording profile to extract the audio clips from. If not specified, raw recordings will be used&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">parser_extraction</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--threads&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;how many threads to run on&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>

        <span class="n">parser_upload</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;upload-chunks&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;upload chunks and updates chunk state&#39;</span><span class="p">)</span>
        <span class="n">parser_upload</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--chunks&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;path to the chunk CSV dataframe&#39;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">parser_upload</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--project-id&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;zooniverse project id&#39;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">parser_upload</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--set-name&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;subject set display name&#39;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">parser_upload</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--amount&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;amount of chunks to upload&#39;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">parser_upload</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--zooniverse-login&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;zooniverse login. If not specified, the program attempts to get it from the environment variable ZOONIVERSE_LOGIN instead&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">parser_upload</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--zooniverse-pwd&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;zooniverse password. If not specified, the program attempts to get it from the environment variable ZOONIVERSE_PWD instead&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">parser_retrieve</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;retrieve-classifications&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;retrieve classifications and save them as &lt;destination&gt;&#39;</span><span class="p">)</span>
        <span class="n">parser_retrieve</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--destination&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;output CSV dataframe destination&#39;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">parser_retrieve</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--project-id&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;zooniverse project id&#39;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">parser_retrieve</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--zooniverse-login&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;zooniverse login. If not specified, the program attempts to get it from the environment variable ZOONIVERSE_LOGIN instead&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">parser_retrieve</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--zooniverse-pwd&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;zooniverse password. If not specified, the program attempts to get it from the environment variable ZOONIVERSE_PWD instead&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Lucas Gautheron.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>